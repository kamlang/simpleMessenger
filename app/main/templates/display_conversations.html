{% extends "parent.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}
	{%set _csrf_token = csrf_token()%}
	<div class="well well-sm" id="status">
		{{ wtf.quick_form(form,form_type="inline",id="profile_form") }}
	    <span id="current_status"><i>  {{ current_user.about_me }}</i> </span>
	    <img title="Click to change your avatar!" class="current_avatar" src="/static/avatars/{{current_user.avatar}}" onerror="this.src='/static/avatars/default.png'">

	</div>
	<div class="well well-sm" id="conversations">
	{%for conversation in conversations%}
	 <div class="well well-sm" id="conversation_{{conversation.id}}">
		{% set last_message = conversation.messages.first() %}
		<span class="participants">Participants: {%for user in conversation.users %}
			{%if current_user.username != user.username%}
			<span class="participant">{{user.username}}
			</span>
			{%else%} Me
			{%endif%} 
	{%endfor%}</span>
	<a href ="{{url_for('main.conversation',conversation_id = conversation.id)}}" class="link_to_conversation">
	<div class="well well-sm message_container" style="background-color: #ffffff;">
		<span class="sender"> From: {{last_message.sender.username}} </span>
		<img class="avatar_message" src="/static/avatars/{{ last_message.sender.avatar}}" onerror="this.src='/static/avatars/default.png'">
			<small style="float: right;" class="timestamp"> {{moment(conversation.timestamp).format('LLL')}}</small>
			<p class="message_content">{{conversation.messages.first().content}}</p>
	</div>
	</a>
	</div>
	{%endfor%}
	{%if prev_url %}<a href={{prev_url}}>Previous</a>{%endif%}
		{%if next_url %}<a href={{next_url}}>Next</a>{%endif%}
		<hr>
		<a href="{{url_for('main.new_conversation')}}">Start a new conversation</a>
	</div>
	<script>

	document.addEventListener('DOMContentLoaded', sse_conversations());

	$('.current_avatar').click(function(){ $('#avatar').trigger('click'); });
	let about_me = document.querySelector('#about_me')
	about_me.setAttribute("title","You can change your status here!")
	let current_status = document.querySelector('#current_status')
	let status_form = document.querySelector('#profile_form')
	about_me.addEventListener("focusin", function() {
			current_status.style.opacity='0'})
	about_me.addEventListener("focusout", function() {
			status_form.reset()
			current_status.style.opacity='1'})
	about_me.addEventListener("keypress",function(event) {
			if (event.keyCode == 13) {
			$('#submit').trigger('click')}
		})
	let avatar = document.querySelector('#avatar')
	avatar.addEventListener("change", function() {
			$('#submit').trigger('click')
		})

	var csrf_token = "{{ csrf_token() }}";
			
            function sse_conversations() {
		var source = new EventSource("{{url_for('main.stream',username = current_user.username)}}");
                source.onmessage = function(e) {
			const json = e.data.replaceAll("'",'"');
			const obj = JSON.parse(json);
			let conversation_to_update = document.querySelector('#conversation_'+ CSS.escape(obj.conversation_id));
			if (conversation_to_update  === null){
				//Create a new element
			conversation_to_update = document.createElement("div");
			conversation_to_update.setAttribute("class","well well-sm");
			conversation_to_update.setAttribute("id","conversation_"+obj.conversation_id);

			const participants =  document.createElement("span");
			participants.setAttribute("class","participants");
			conversation_to_update.appendChild(participants);

			const link_to_conversation =  document.createElement("a");
			link_to_conversation.setAttribute("class","link_to_conversation");
			link_to_conversation.setAttribute("href","/conversation_"+obj.conversation_id );
			conversation_to_update.appendChild(link_to_conversation);

			const message = document.createElement("div");
			message.setAttribute("class","well well-sm message_container");
			link_to_conversation.appendChild(message);

			const fromNode = document.createElement("span");
			fromNode.setAttribute("class","sender");

			const timestampNode = document.createElement("small");
			timestampNode.setAttribute("class","timestamp");
			timestampNode.setAttribute("style","float:right;");

			const messageNode = document.createElement("p");
			messageNode.setAttribute("class","message_content");

			message.appendChild(fromNode);
			message.appendChild(timestampNode);
			message.appendChild(messageNode);
			};

			const updated_conversation = conversation_to_update.cloneNode(true);
			updated_conversation.querySelector('.participants').innerText = "Participants: " + obj.participants
			updated_conversation.querySelector('.avatar_message').setAttribute("src","/static/avatars/"+ obj.avatar_name)
			updated_conversation.querySelector('.message_content').innerText = obj.content;
			updated_conversation.querySelector('.timestamp').innerText = moment().format('LLL');
			updated_conversation.querySelector('.sender').innerText = "From: " + obj.from;
			updated_conversation.setAttribute('style', 'background-color:LightCoral;')
			const last_conversation = document.querySelector('#conversations').firstElementChild;
			document.querySelector('#conversations').insertBefore(updated_conversation,last_conversation);
			conversation_to_update.remove();

                };
            }

	var all_participant_elements  =  document.querySelectorAll('.participant');
	var popup = null	
	var timeout = null
	all_participant_elements.forEach(
	function(participant_element) {
		var username = participant_element.innerText.trim()
		if (username && participant_element) {
			participant_element.addEventListener("mouseover", function() {
			timeout = setTimeout(function(){
				timeout = null
				get_user_info(username).then((user_data) => {
				content_html = "<small> Last seen on: " + moment(user_data.last_seen).format('LLL') + "</small>" 			
				if(user_data.about_me) {
						content_html = content_html + "<br><i>\u0022" + user_data.about_me.trim() + "\u0022 </i>"}

					popup = $(participant_element).popover({
					html: true,
					title: username, 
					content: content_html
				});
					popup.popover('show')}).catch(err => console.log(err))
					popup = null
				},1000)})
			participant_element.addEventListener("mouseout", function() {
					if (timeout) {clearTimeout(timeout);timeout=null}
					if (popup) {popup.popover('destroy');popup=null}
						}
			)}})
</script>
{% endblock %}    


